name: üîê WINCOVA Security Audit Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  # ============================================
  # FASE 1: Code Quality & Type Safety
  # ============================================
  code-quality:
    name: üìã Code Quality Analysis
    runs-on: ubuntu-latest
    steps:
      - name: üîç Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üì• Install dependencies
        run: npm ci

      - name: üîé Run ESLint
        run: npm run lint || echo "::warning::Linting issues found"
        continue-on-error: true

      - name: üîç TypeScript Type Check
        run: npx tsc --noEmit

      - name: üìä Upload ESLint results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: eslint-results
          path: eslint-report.json
          retention-days: 30

  # ============================================
  # FASE 2: Automated Testing
  # ============================================
  testing:
    name: üß™ Automated Tests
    runs-on: ubuntu-latest
    steps:
      - name: üîç Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üì• Install dependencies
        run: npm ci

      - name: üß™ Run Tests with Coverage
        run: npm run test || echo "::warning::Some tests failed"
        continue-on-error: true

      - name: üìä Generate Test Report
        if: always()
        run: |
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "Tests executed at $(date)" >> $GITHUB_STEP_SUMMARY

      - name: üìà Upload Coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

  # ============================================
  # FASE 3: Security Scanning
  # ============================================
  security:
    name: üõ°Ô∏è Security Analysis
    runs-on: ubuntu-latest
    steps:
      - name: üîç Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üì• Install dependencies
        run: npm ci

      - name: üîê Run npm audit
        run: |
          npm audit --json > audit-report.json || true
          echo "## Security Audit" >> $GITHUB_STEP_SUMMARY
          npm audit || echo "::warning::Security vulnerabilities found"
        continue-on-error: true

      - name: üìä Upload Audit Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-audit
          path: audit-report.json
          retention-days: 30

      - name: üîç Check for hardcoded secrets
        run: |
          echo "Scanning for hardcoded secrets..."
          if grep -r "sk_live_" src/ 2>/dev/null; then
            echo "::error::Found potential Stripe live keys!"
            exit 1
          fi
          if grep -r "password.*=.*['\"]" src/ 2>/dev/null | grep -v "placeholder"; then
            echo "::warning::Found potential hardcoded passwords"
          fi
          echo "‚úÖ No obvious hardcoded secrets found"

  # ============================================
  # FASE 4: AI Code Analysis with OpenAI
  # ============================================
  ai-analysis:
    name: ü§ñ OpenAI Code Analysis
    runs-on: ubuntu-latest
    needs: [code-quality, testing, security]
    if: always()
    steps:
      - name: üîç Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: üìä Get commit changes
        id: get-diff
        run: |
          echo "Getting diff for commit ${{ github.sha }}"
          git diff HEAD^ HEAD > changes.diff
          
          # Get list of changed files
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD | tr '\n' ',' | sed 's/,$//')
          echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          
          # Check if diff is too large (max 100KB for API)
          DIFF_SIZE=$(wc -c < changes.diff)
          echo "Diff size: $DIFF_SIZE bytes"
          
          if [ $DIFF_SIZE -gt 100000 ]; then
            echo "‚ö†Ô∏è Diff too large, truncating..."
            head -c 100000 changes.diff > changes_truncated.diff
            mv changes_truncated.diff changes.diff
          fi

      - name: ü§ñ Analyze with OpenAI
        id: ai-analysis
        continue-on-error: true
        run: |
          echo "Analyzing code changes with OpenAI..."
          
          # Read diff content
          DIFF_CONTENT=$(cat changes.diff | jq -Rs .)
          
          # Create OpenAI request
          RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer ${{ secrets.OPENAI_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"model\": \"gpt-5\",
              \"messages\": [
                {
                  \"role\": \"system\",
                  \"content\": \"Eres un auditor de c√≥digo experto. Analiza los cambios y clasif√≠calos en: CRITICAL (seguridad, bugs que rompen funcionalidad), IMPORTANT (performance, calidad de c√≥digo), SUGGESTION (mejoras opcionales). Responde SOLO con JSON v√°lido en este formato: {\\\"corrections\\\": [{\\\"severity\\\": \\\"critical|important|suggestion\\\", \\\"file\\\": \\\"ruta/archivo\\\", \\\"line\\\": 123, \\\"title\\\": \\\"T√≠tulo breve\\\", \\\"description\\\": \\\"Descripci√≥n detallada\\\", \\\"code_before\\\": \\\"c√≥digo anterior\\\", \\\"code_after\\\": \\\"c√≥digo sugerido\\\"}]}\"
                },
                {
                  \"role\": \"user\",
                  \"content\": \"Analiza estos cambios de c√≥digo y sugiere correcciones:\n\nArchivos modificados: ${{ steps.get-diff.outputs.changed_files }}\n\nDiff:\n${DIFF_CONTENT}\"
                }
              ],
              \"temperature\": 0.3,
              \"max_completion_tokens\": 4000
            }")
          
          # Extract AI response
          AI_ANALYSIS=$(echo "$RESPONSE" | jq -r '.choices[0].message.content')
          
          # Save to output
          echo "ai_analysis<<EOF" >> $GITHUB_OUTPUT
          echo "$AI_ANALYSIS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Check for errors
          if echo "$RESPONSE" | jq -e '.error' > /dev/null; then
            ERROR_MSG=$(echo "$RESPONSE" | jq -r '.error.message')
            echo "::error::OpenAI API Error: $ERROR_MSG"
          else
            echo "‚úÖ AI analysis completed successfully"
          fi

      - name: üì§ Upload AI Analysis
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ai-analysis
          path: changes.diff
          retention-days: 30

  # ============================================
  # FASE 5: Build Verification
  # ============================================
  build:
    name: üèóÔ∏è Build Verification
    runs-on: ubuntu-latest
    needs: [code-quality, testing]
    steps:
      - name: üîç Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üì• Install dependencies
        run: npm ci

      - name: üèóÔ∏è Build Project
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL || 'https://placeholder.supabase.co' }}
          VITE_SUPABASE_PUBLISHABLE_KEY: ${{ secrets.VITE_SUPABASE_PUBLISHABLE_KEY || 'placeholder-key' }}
          VITE_SUPABASE_PROJECT_ID: ${{ secrets.VITE_SUPABASE_PROJECT_ID || 'placeholder-id' }}

      - name: üìä Check Build Size
        run: |
          BUILD_SIZE=$(du -sh dist | cut -f1)
          echo "## Build Analysis" >> $GITHUB_STEP_SUMMARY
          echo "üì¶ Build size: $BUILD_SIZE" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Build completed successfully" >> $GITHUB_STEP_SUMMARY

      - name: üì§ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: dist/
          retention-days: 7

  # ============================================
  # REPORTING: Send Results to Webhook
  # ============================================
  report:
    name: üì° Report to WINCOVA Dashboard
    runs-on: ubuntu-latest
    needs: [code-quality, testing, security, ai-analysis, build]
    if: always()
    steps:
      - name: üìä Collect Results
        id: collect
        run: |
          echo "Collecting audit results..."
          
          # Get AI analysis if available
          AI_ANALYSIS="${{ needs.ai-analysis.outputs.ai_analysis }}"
          if [ -n "$AI_ANALYSIS" ]; then
            echo "ai_analysis=$AI_ANALYSIS" >> $GITHUB_OUTPUT
          else
            echo "ai_analysis={}" >> $GITHUB_OUTPUT
          fi
          
          # Determine overall status
          if [[ "${{ needs.code-quality.result }}" == "failure" ]] || \
             [[ "${{ needs.testing.result }}" == "failure" ]] || \
             [[ "${{ needs.security.result }}" == "failure" ]] || \
             [[ "${{ needs.build.result }}" == "failure" ]]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "conclusion=failure" >> $GITHUB_OUTPUT
          else
            echo "status=success" >> $GITHUB_OUTPUT
            echo "conclusion=success" >> $GITHUB_OUTPUT
          fi

      - name: üì° Send to Webhook
        if: always()
        run: |
          # Escape commit message for JSON
          COMMIT_MSG=$(echo "${{ github.event.head_commit.message }}" | jq -Rs .)
          
          # Escape AI analysis for JSON
          AI_ANALYSIS='${{ steps.collect.outputs.ai_analysis }}'
          if [ -z "$AI_ANALYSIS" ] || [ "$AI_ANALYSIS" = "{}" ]; then
            AI_ANALYSIS_JSON="null"
          else
            AI_ANALYSIS_JSON=$(echo "$AI_ANALYSIS" | jq -Rs .)
          fi
          
          # Build and send payload
          curl -X POST "${{ secrets.WINCOVA_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -H "X-GitHub-Event: workflow_run" \
            -d '{
              "action": "completed",
              "workflow_run": {
                "id": ${{ github.run_id }},
                "name": "${{ github.workflow }}",
                "head_branch": "${{ github.ref_name }}",
                "head_sha": "${{ github.sha }}",
                "head_commit": {
                  "message": '"${COMMIT_MSG}"'
                },
                "event": "${{ github.event_name }}",
                "status": "completed",
                "conclusion": "${{ steps.collect.outputs.conclusion }}",
                "html_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                "run_number": ${{ github.run_number }},
                "run_attempt": ${{ github.run_attempt }},
                "triggering_actor": {
                  "login": "${{ github.actor }}"
                },
                "created_at": "${{ github.event.repository.created_at }}",
                "updated_at": "${{ github.event.repository.updated_at }}",
                "ai_analysis": '"${AI_ANALYSIS_JSON}"'
              },
              "repository": {
                "full_name": "${{ github.repository }}",
                "html_url": "${{ github.server_url }}/${{ github.repository }}"
              }
            }' || echo "::warning::Failed to send webhook notification"

      - name: ‚úÖ Summary
        if: always()
        run: |
          echo "# üîê WINCOVA Audit Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ steps.collect.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìä **Results:**" >> $GITHUB_STEP_SUMMARY
          echo "- Code Quality: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Testing: ${{ needs.testing.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security: ${{ needs.security.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- AI Analysis: ${{ needs.ai-analysis.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üîó [View Full Report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
